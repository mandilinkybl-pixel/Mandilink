<%- include('layout/header') %>
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
       <div class="container-fluid">

<div class="container-fluid p-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Plans</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPlanModal">
      + Create Plan
    </button>
  </div>

  <!-- Search -->
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search plans by name...">

  <div class="row" id="plansContainer">
    <% if(plans.length === 0){ %>
      <div class="text-center text-muted">No plans found.</div>
    <% } %>
    <% plans.forEach(plan => { %>
      <div class="col-md-4 mb-4 plan-card" data-name="<%= plan.name.toLowerCase() %>">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title"><%= plan.name %></h5>
            <p><%= plan.description || "No description" %></p>
            <p><strong>Price:</strong> ₹<%= plan.price %></p>
            <p><strong>Duration:</strong> <%= plan.duration %> days</p>
            <p><strong>Chatbot:</strong> Delay <%= plan.chatbot.delay %>s, Credits <%= plan.chatbot.credits %></p>
            <p><strong>Allowed Subroles:</strong>
              <% if(plan.allowedSubroles.length === 0){ %>All<% } else { %>
                <%= plan.allowedSubroles.map(sr => sr.name).join(", ") %>
              <% } %>
            </p>

            <!-- Access Features -->
            <div class="mb-2">
              <% Object.keys(plan.access).forEach(key => { %>
                <span class="badge bg-<%= plan.access[key] ? 'success' : 'secondary' %>"><%= key %></span>
              <% }) %>
            </div>

            <!-- Actions -->
            <button 
              class="btn btn-sm btn-warning editBtn" 
              data-bs-toggle="modal" 
              data-bs-target="#editPlanModal"
              data-id="<%= plan._id %>"
              data-name="<%= plan.name %>"
              data-description="<%= plan.description %>"
              data-price="<%= plan.price %>"
              data-duration="<%= plan.duration %>"
              data-delay="<%= plan.chatbot.delay %>"
              data-credits="<%= plan.chatbot.credits %>"
              data-access='<%- JSON.stringify(plan.access) %>'
              data-subroles='<%- JSON.stringify(plan.allowedSubroles.map(sr => sr._id)) %>'
            >Edit</button>

            <form action="/employees/plans/<%= plan._id %>?_method=DELETE" method="POST" class="d-inline">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this plan?')">Delete</button>
            </form>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createPlanModal" tabindex="-1" style="padding-top: 100px;">
  <div class="modal-dialog">
    <form action="/employees/plans/Create" method="POST" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="name" class="form-control mb-2" placeholder="Plan Name" required>
        <textarea name="description" class="form-control mb-2" placeholder="Description"></textarea>
        <input type="number" name="price" class="form-control mb-2" placeholder="Price (₹)" required>
        <input type="number" name="duration" class="form-control mb-2" placeholder="Duration (days)" required>
        <input type="number" name="chatbotDelay" class="form-control mb-2" placeholder="Chatbot Delay (seconds)">
        <input type="number" name="chatbotCredits" class="form-control mb-2" placeholder="Chatbot Credits">

        <label class="fw-bold">Access Features</label><br>
        <% const features = ["chat","contact","postAds","premiumBadge","jobPost","bidding","bidPost","profileHighlight","prioritySupport","unlimitedMessages","analytics","boostAds","multipleLanguages","featuredPlacement"]; %>
        <% features.forEach(f => { %>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" name="<%= f %>"> <%= f %>
          </div>
        <% }) %>

        <label class="fw-bold mt-2">Allowed Subroles</label>
        <select name="allowedSubroles" class="form-select" multiple>
          <% subroles.forEach(sr => { %>
            <option value="<%= sr._id %>"><%= sr.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editPlanModal" tabindex="-1" style="padding-top: 100px;">
  <div class="modal-dialog">
    <form method="POST" class="modal-content" id="editPlanForm">
      <input type="hidden" name="_method" value="PUT">
      <div class="modal-header">
        <h5 class="modal-title">Edit Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="editName" name="name" class="form-control mb-2" required>
        <textarea id="editDescription" name="description" class="form-control mb-2"></textarea>
        <input id="editPrice" type="number" name="price" class="form-control mb-2" required>
        <input id="editDuration" type="number" name="duration" class="form-control mb-2" required>
        <input id="editDelay" type="number" name="chatbotDelay" class="form-control mb-2">
        <input id="editCredits" type="number" name="chatbotCredits" class="form-control mb-2">

        <label class="fw-bold">Access Features</label><br>
        <% features.forEach(f => { %>
          <div class="form-check">
            <input id="edit<%= f %>" type="checkbox" class="form-check-input" name="<%= f %>"> <%= f %>
          </div>
        <% }) %>

        <label class="fw-bold mt-2">Allowed Subroles</label>
        <select id="editSubroles" name="allowedSubroles" class="form-select" multiple>
          <% subroles.forEach(sr => { %>
            <option value="<%= sr._id %>"><%= sr.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success">Update</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Search functionality
  const searchInput = document.getElementById("searchInput");
  searchInput.addEventListener("keyup", function() {
    const value = this.value.toLowerCase();
    document.querySelectorAll(".plan-card").forEach(card => {
      const name = card.dataset.name;
      card.style.display = name.includes(value) ? "" : "none";
    });
  });

  // Fill edit modal
  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", function() {
      const access = JSON.parse(this.dataset.access);
      const subroles = JSON.parse(this.dataset.subroles);

      document.getElementById("editPlanForm").action = "/employees/plans/" + this.dataset.id;
      document.getElementById("editName").value = this.dataset.name;
      document.getElementById("editDescription").value = this.dataset.description;
      document.getElementById("editPrice").value = this.dataset.price;
      document.getElementById("editDuration").value = this.dataset.duration;
      document.getElementById("editDelay").value = this.dataset.delay;
      document.getElementById("editCredits").value = this.dataset.credits;

      // Set access checkboxes
      Object.keys(access).forEach(key => {
        const el = document.getElementById("edit" + key);
        if(el) el.checked = access[key];
      });

      // Set subroles
      const select = document.getElementById("editSubroles");
      for(let i = 0; i < select.options.length; i++){
        select.options[i].selected = subroles.includes(select.options[i].value);
      }
    });
  });
</script>



        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Sidebar Toggle JS -->
    <script>
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
        });
    </script>
</body>
</html>