<%- include('common/header') %>

    <div class="main-content" id="mainContent">

<div class="container mt-4">
  <h2>Company Listing</h2>


  <!-- FILTER BAR -->
  <div class="row mb-2" id="filterBar">
    <div class="col-md-3">
      <select id="filterCategory" class="form-select" required>
        <option value="">Select Category</option>
        <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>" <%= selectedCategory==cat._id?'selected':'' %>><%= cat.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select id="filterState" class="form-select" required>
        <option value="">Select State</option>
        <% states.forEach(st => { %>
          <option value="<%= st._id %>" <%= selectedState==st._id?'selected':'' %>><%= st.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select id="filterDistrict" class="form-select" required>
        <option value=""><%= selectedDistrict || 'Select District' %></option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="filterMandi" class="form-select" required>
        <option value=""><%= selectedMandi || 'Select Mandi' %></option>
      </select>
    </div>
  </div>

  <!-- INSTANT SEARCH BAR -->
  <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search company table...">

  <!-- ADD/EDIT COMPANIES FORM -->
  <form action="/admin/companylist/add" method="POST" id="addCompanyForm">
    <!-- Hidden filter values -->
    <input type="hidden" name="category" id="hiddenCategory" value="<%= selectedCategory %>">
    <input type="hidden" name="state" id="hiddenState" value="<%= selectedState %>">
    <input type="hidden" name="district" id="hiddenDistrict" value="<%= selectedDistrict %>">
    <input type="hidden" name="mandi" id="hiddenMandi" value="<%= selectedMandi %>">
    <table class="table table-bordered" id="companyTable">
      <thead>
        <tr>
          <th>S.No</th>
          <th>Company Name</th>
          <th>Address</th>
          <th>Contact Person</th>
          <th>Contact Number</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="companyRowsWrapper">
        <% companies.forEach((c,i) => { %>
          <tr class="companyRow existingRow"
              data-category="<%= c.category %>"
              data-state="<%= c.state %>"
              data-district="<%= c.district %>"
              data-mandi="<%= c.mandi %>">
            <td><%= i+1 %></td>
            <td><%= c.name %></td>
            <td><%= c.address %></td>
            <td><%= c.contactPerson %></td>
            <td><%= c.contactNumber %></td>
            <td>
              <button type="button"
                      class="btn btn-sm btn-primary editBtn"
                      data-id="<%= c._id %>"
                      data-name="<%= c.name %>"
                      data-address="<%= c.address %>"
                      data-contactperson="<%= c.contactPerson %>"
                      data-contactnumber="<%= c.contactNumber %>"
                      title="Edit">
                <i class="bi bi-pencil-square"></i>
              </button>
              <a href="/admin/companylist/delete/<%= c._id %>"
                 class="btn btn-sm btn-danger"
                 onclick="return confirm('Are you sure?')"
                 title="Delete">
                <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>
        <% }) %>
        <!-- ADD ROWS (at bottom, always one blank row) -->
        <tr class="companyRow addRow">
          <td class="serialNo"><%= companies.length+1 %></td>
          <td><input type="text" name="names[]" class="form-control" placeholder="Company Name" required></td>
          <td><input type="text" name="addresses[]" class="form-control" placeholder="Full Address" required></td>
          <td><input type="text" name="contactPersons[]" class="form-control" placeholder="Contact Person" required></td>
          <td><input type="text" name="contactNumbers[]" class="form-control" placeholder="Contact Number" required></td>
          <td><button type="button" class="btn btn-danger removeRow" style="display:none;"><i class="bi bi-x-circle"></i></button></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="6">
            <button type="submit" class="btn btn-success" id="saveAllBtn">Save All</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </form>
</div>

<!-- Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editCompanyForm" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Company</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCompanyId" name="id">
          <div class="mb-2">
            <label>Company Name</label>
            <input type="text" id="editName" name="name" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Address</label>
            <input type="text" id="editAddress" name="address" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Contact Person</label>
            <input type="text" id="editContactPerson" name="contactPerson" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Contact Number</label>
            <input type="text" id="editContactNumber" name="contactNumber" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Update</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script>
document.addEventListener("DOMContentLoaded", function() {
  // ------------------- FILTER DROPDOWNS -------------------
  const filterCategory = document.getElementById("filterCategory");
  const filterState = document.getElementById("filterState");
  const filterDistrict = document.getElementById("filterDistrict");
  const filterMandi = document.getElementById("filterMandi");
  const hiddenCategory = document.getElementById("hiddenCategory");
  const hiddenState = document.getElementById("hiddenState");
  const hiddenDistrict = document.getElementById("hiddenDistrict");
  const hiddenMandi = document.getElementById("hiddenMandi");

  function updateHiddenInputsAndFilter() {
    hiddenCategory.value = filterCategory.value;
    hiddenState.value = filterState.value;
    hiddenDistrict.value = filterDistrict.value;
    hiddenMandi.value = filterMandi.value;
    filterTable();
    updateAddRowState();
  }

  filterCategory.addEventListener("change", updateHiddenInputsAndFilter);
  filterState.addEventListener("change", function() {
    loadFilterDistricts(this.value, "", filterDistrict, filterMandi);
    updateHiddenInputsAndFilter();
  });
  filterDistrict.addEventListener("change", function() {
    loadFilterMandis(this.value, "", filterMandi);
    updateHiddenInputsAndFilter();
  });
  filterMandi.addEventListener("change", updateHiddenInputsAndFilter);

  async function loadFilterDistricts(stateId, selectedDistrict="", districtSelect, mandiSelect){
    districtSelect.innerHTML = '<option value="">Select District</option>';
    mandiSelect.innerHTML = '<option value="">Select Mandi</option>';
    if(!stateId) return;
    const res = await fetch(`/admin/companylist/districts/${stateId}`);
    const districts = await res.json();
    districts.forEach(d=>{
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      if(d==selectedDistrict) opt.selected = true;
      districtSelect.appendChild(opt);
    });
    if(selectedDistrict) loadFilterMandis(selectedDistrict, "", mandiSelect);
    updateHiddenInputsAndFilter();
  }
  async function loadFilterMandis(district, selectedMandi="", mandiSelect){
    mandiSelect.innerHTML = '<option value="">Select Mandi</option>';
    if(!district) return;
    const res = await fetch(`/admin/companylist/mandis/${district}`);
    const mandis = await res.json();
    mandis.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.name;
      opt.textContent = m.name;
      if(m.name==selectedMandi) opt.selected=true;
      mandiSelect.appendChild(opt);
    });
    updateHiddenInputsAndFilter();
  }

  document.getElementById('searchInput').addEventListener('input', filterTable);

  function filterTable() {
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.existingRow').forEach(row => {
      let match = true;
      if(searchVal) {
        match = row.textContent.toLowerCase().includes(searchVal);
      }
      if(match && filterCategory.value) match = row.dataset.category === filterCategory.value;
      if(match && filterState.value) match = row.dataset.state === filterState.value;
      if(match && filterDistrict.value) match = row.dataset.district === filterDistrict.value;
      if(match && filterMandi.value) match = row.dataset.mandi === filterMandi.value;
      row.style.display = match ? '' : 'none';
    });
  }

  function updateAddRowState() {
    const allFilled = filterCategory.value && filterState.value && filterDistrict.value && filterMandi.value;
    document.querySelectorAll('.addRow input, .addRow button').forEach(el => {
      el.disabled = !allFilled;
    });
    document.getElementById('saveAllBtn').disabled = !allFilled;
  }
  updateAddRowState();

  const companyRowsWrapper = document.getElementById("companyRowsWrapper");
  companyRowsWrapper.addEventListener("keydown", function(e){
    if(e.key==='Enter' && !e.shiftKey) {
      const targetRow = e.target.closest('.addRow');
      if(targetRow) {
        e.preventDefault();
        addCompanyRow();
      }
    }
  });

  function addCompanyRow() {
    const index = document.querySelectorAll('.addRow').length + document.querySelectorAll('.existingRow').length;
    const row = document.createElement("tr");
    row.className = "companyRow addRow";
    row.innerHTML = `
      <td class="serialNo">${index+1}</td>
      <td><input type="text" name="names[]" class="form-control" placeholder="Company Name" required></td>
      <td><input type="text" name="addresses[]" class="form-control" placeholder="Full Address" required></td>
      <td><input type="text" name="contactPersons[]" class="form-control" placeholder="Contact Person" required></td>
      <td><input type="text" name="contactNumbers[]" class="form-control" placeholder="Contact Number" required></td>
      <td><button type="button" class="btn btn-danger removeRow"><i class="bi bi-x-circle"></i></button></td>
    `;
    companyRowsWrapper.appendChild(row);
    row.querySelector('input').focus();
    updateSerials();
    updateAddRowState();
  }
  companyRowsWrapper.addEventListener("click", function(e){
    if(e.target.closest(".removeRow")){
      e.target.closest(".addRow").remove();
      updateSerials();
    }
  });
  function updateSerials(){
    Array.from(companyRowsWrapper.children).forEach((row,i)=>{
      row.querySelector(".serialNo").textContent = i+1;
    });
  }
  document.addEventListener("keydown", function(e) {
    if(e.ctrlKey && e.key.toLowerCase() === 'c') {
      document.getElementById('addCompanyForm').submit();
    }
  });

  // ------------------- EDIT MODAL LOGIC -------------------
  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", function(){
      document.getElementById("editCompanyId").value = this.dataset.id;
      document.getElementById("editName").value = this.dataset.name;
      document.getElementById("editAddress").value = this.dataset.address;
      document.getElementById("editContactPerson").value = this.dataset.contactperson;
      document.getElementById("editContactNumber").value = this.dataset.contactnumber;
      document.getElementById("editCompanyForm").action = `/admin/companylist/edit/${this.dataset.id}`;
      var editModal = new bootstrap.Modal(document.getElementById("editCompanyModal"));
      editModal.show();
    });
  });
});
</script>

<!-- bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   
    <!-- Custom JS for sidebar -->
    <script>
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
        });
    </script>
</body>
</html>