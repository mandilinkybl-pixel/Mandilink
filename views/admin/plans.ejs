<%- include('common/header') %>
<!-- Main Content -->
<div class="main-content" id="mainContent">
  <div class="container-fluid">

    <div class="container-fluid p-4">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Plans</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPlanModal">
          + Create Plan
        </button>
      </div>

      <!-- Search -->
      <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search plans by name...">

      <div class="row" id="plansContainer">
        <% if(plans.length === 0){ %>
          <div class="text-center text-muted">No plans found.</div>
        <% } %>
        <% plans.forEach(plan => { %>
          <div class="col-md-4 mb-4 plan-card" data-name="<%= plan.name.toLowerCase() %>">
            <div 
              class="h-100"
              style="border-radius: 22px; overflow: hidden; box-shadow: 0 8px 24px rgba(100,100,255,0.09), 0 1.5px 4.5px rgba(0,0,0,0.08); background: linear-gradient(120deg,#f8fafc 0%,#e0e7ff 100%); border: none; transition: transform 0.18s, box-shadow 0.18s;">
              <div 
                style="background:linear-gradient(90deg,#6366f1 0%,#60a5fa 100%);padding:24px 16px 18px 16px;color:#fff;text-align:center;">
                <h5 style="margin:0;font-size:1.5rem;letter-spacing:.5px;font-weight:700;"><%= plan.name %></h5>
              </div>
              <div class="card-body" style="padding:24px;">
                <p style="color:#6b7280;margin-bottom:12px;font-size:1rem;"><%= plan.description || "No description" %></p>
                <div style="font-size:1.8rem;font-weight:bold;color:#6366f1;margin-bottom:10px;">₹<%= plan.price %></div>
                <div style="margin-bottom:8px;"><strong>Duration:</strong> <%= plan.duration %> days</div>
                <div style="margin-bottom:10px;"><strong>Chatbot:</strong>
                  <span style="background:#38bdf8;color:#fff;border-radius:1rem;padding:4px 12px;font-size:0.95em;margin-right:6px;">Delay <%= plan.chatbot.delay %>s</span>
                  <span style="background:#fde68a;color:#92400e;border-radius:1rem;padding:4px 12px;font-size:0.95em;">Credits <%= plan.chatbot.credits %></span>
                </div>
                <div style="margin-bottom:10px;">
                  <strong>Allowed Subroles:</strong>
                  <% if(plan.allowedSubroles.length === 0){ %>
                    <span style="background:#f3f4f6;color:#6b7280;border-radius:1rem;padding:4px 12px;font-size:0.95em;">All</span>
                  <% } else { %>
                    <%- plan.allowedSubroles.map(sr => `<span style="background:#e0e7ff;color:#3730a3;border-radius:1rem;padding:4px 12px;font-size:0.95em;margin-right:4px;">${sr.name}</span>`).join(" ") %>
                  <% } %>
                </div>
                <div style="margin-bottom:18px;">
                  <% Object.keys(plan.access).forEach(key => { %>
                    <span style="font-size:0.85rem;margin:2px 4px 2px 0;padding:4px 14px;border-radius:1rem;font-weight:500;
                      background:<%= plan.access[key] ? '#e0e7ff' : '#f3f4f6' %>;
                      color:<%= plan.access[key] ? '#064e3b' : '#6b7280' %>;
                      border:none;display:inline-block;">
                      <%= key %>
                    </span>
                  <% }) %>
                </div>
                <div style="display:flex;gap:0.5rem;">
                  <button 
                    class="btn btn-sm btn-warning editBtn" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editPlanModal"
                    data-id="<%= plan._id %>"
                    data-name="<%= plan.name %>"
                    data-description="<%= plan.description %>"
                    data-price="<%= plan.price %>"
                    data-duration="<%= plan.duration %>"
                    data-delay="<%= plan.chatbot.delay %>"
                    data-credits="<%= plan.chatbot.credits %>"
                    data-access='<%- JSON.stringify(plan.access) %>'
                    data-subroles='<%- JSON.stringify(plan.allowedSubroles.map(sr => sr._id)) %>'
                    style="border-radius:10px;font-weight:500;"
                  >Edit</button>
                  <form action="/admin/plans/<%= plan._id %>?_method=DELETE" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this plan?')" style="border-radius:10px;font-weight:500;">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- CREATE MODAL -->
    <div class="modal fade" id="createPlanModal" tabindex="-1" style="padding-top: 100px;">
      <div class="modal-dialog">
        <form action="/admin/plans/Create" method="POST" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create Plan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input name="name" class="form-control mb-2" placeholder="Plan Name" required>
            <textarea name="description" class="form-control mb-2" placeholder="Description"></textarea>
            <input type="number" name="price" class="form-control mb-2" placeholder="Price (₹)" required>
            <input type="number" name="duration" class="form-control mb-2" placeholder="Duration (days)" required>
            <input type="number" name="chatbotDelay" class="form-control mb-2" placeholder="Chatbot Delay (seconds)">
            <input type="number" name="chatbotCredits" class="form-control mb-2" placeholder="Chatbot Credits">

            <label class="fw-bold">Access Features</label><br>
            <% const features = ["chat","contact","postAds","premiumBadge","jobPost","bidding","bidPost","profileHighlight","prioritySupport","unlimitedMessages","analytics","boostAds","multipleLanguages","featuredPlacement"]; %>
            <% features.forEach(f => { %>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" name="<%= f %>"> <%= f %>
              </div>
            <% }) %>

            <label class="fw-bold mt-2">Allowed Subroles</label>
            <select name="allowedSubroles" class="form-select" multiple>
              <% subroles.forEach(sr => { %>
                <option value="<%= sr._id %>"><%= sr.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal fade" id="editPlanModal" tabindex="-1" style="padding-top: 100px;">
      <div class="modal-dialog">
        <form method="POST" class="modal-content" id="editPlanForm">
          <input type="hidden" name="_method" value="PUT">
          <div class="modal-header">
            <h5 class="modal-title">Edit Plan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input id="editName" name="name" class="form-control mb-2" required>
            <textarea id="editDescription" name="description" class="form-control mb-2"></textarea>
            <input id="editPrice" type="number" name="price" class="form-control mb-2" required>
            <input id="editDuration" type="number" name="duration" class="form-control mb-2" required>
            <input id="editDelay" type="number" name="chatbotDelay" class="form-control mb-2">
            <input id="editCredits" type="number" name="chatbotCredits" class="form-control mb-2">

            <label class="fw-bold">Access Features</label><br>
            <% features.forEach(f => { %>
              <div class="form-check">
                <input id="edit<%= f %>" type="checkbox" class="form-check-input" name="<%= f %>"> <%= f %>
              </div>
            <% }) %>

            <label class="fw-bold mt-2">Allowed Subroles</label>
            <select id="editSubroles" name="allowedSubroles" class="form-select" multiple>
              <% subroles.forEach(sr => { %>
                <option value="<%= sr._id %>"><%= sr.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success">Update</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Search functionality
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("keyup", function() {
        const value = this.value.toLowerCase();
        document.querySelectorAll(".plan-card").forEach(card => {
          const name = card.dataset.name;
          card.style.display = name.includes(value) ? "" : "none";
        });
      });

      // Fill edit modal
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", function() {
          const access = JSON.parse(this.dataset.access);
          const subroles = JSON.parse(this.dataset.subroles);

          document.getElementById("editPlanForm").action = "/admin/plans/" + this.dataset.id;
          document.getElementById("editName").value = this.dataset.name;
          document.getElementById("editDescription").value = this.dataset.description;
          document.getElementById("editPrice").value = this.dataset.price;
          document.getElementById("editDuration").value = this.dataset.duration;
          document.getElementById("editDelay").value = this.dataset.delay;
          document.getElementById("editCredits").value = this.dataset.credits;

          // Set access checkboxes
          Object.keys(access).forEach(key => {
            const el = document.getElementById("edit" + key);
            if(el) el.checked = access[key];
          });

          // Set subroles
          const select = document.getElementById("editSubroles");
          for(let i = 0; i < select.options.length; i++){
            select.options[i].selected = subroles.includes(select.options[i].value);
          }
        });
      });
    </script>

  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS for sidebar -->
<script>
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');
  const sidebarToggle = document.getElementById('sidebarToggle');

  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('collapsed');
  });
</script>
</body>
</html>