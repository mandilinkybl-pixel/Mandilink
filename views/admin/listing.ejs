<%- include('common/header') %>

<div class="main-content" id="mainContent">
  <div class="container mt-4">
    <h2>User Listing</h2>

    <!-- FILTER BAR -->
    <div class="row mb-3" id="filterBar">
      <div class="col-md-3">
        <select id="filterCategory" class="form-select" required>
          <option value="">Select Category</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>" <%= selectedCategory==cat._id?'selected':'' %>><%= cat.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-3">
        <select id="filterState" class="form-select" required>
          <option value="">Select State</option>
          <% states.forEach(st => { %>
            <option value="<%= st._id %>" <%= selectedState==st._id?'selected':'' %>><%= st.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-3">
        <select id="filterDistrict" class="form-select" required>
          <option value=""><%= selectedDistrict || 'Select District' %></option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="filterMandi" class="form-select" required>
          <option value=""><%= selectedMandi || 'Select Mandi' %></option>
        </select>
      </div>
    </div>

    <!-- INSTANT SEARCH BAR AND EXPORT BUTTONS -->
    <div class="row mb-3">
      <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="Search user table...">
      </div>
      <div class="col-md-6 text-end">
        <button type="button" class="btn btn-outline-primary me-2" id="viewTableBtn" data-bs-toggle="modal" data-bs-target="#viewTableModal">View Table</button>
        <button type="button" class="btn btn-outline-primary me-2" id="downloadCSV">Download CSV</button>
        <button type="button" class="btn btn-outline-success me-2" id="downloadExcel">Download Excel</button>
        <button type="button" class="btn btn-outline-danger" id="downloadPDF">Download PDF</button>
      </div>
    </div>

    <!-- ROW COUNT DISPLAY -->
    <div class="row mb-3">
      <div class="col-md-12">
        <p id="rowCountDisplay" class="text-muted">
          Showing <span id="filteredRowCount">0</span> of <span id="totalRowCount">0</span> users
        </p>
      </div>
    </div>

    <!-- ADD/EDIT USERS FORM -->
    <form action="/admin/userlist/add" method="POST" id="addUserForm">
      <input type="hidden" name="category" id="hiddenCategory" value="<%= selectedCategory %>">
      <input type="hidden" name="state" id="hiddenState" value="<%= selectedState %>">
      <input type="hidden" name="district" id="hiddenDistrict" value="<%= selectedDistrict %>">
      <input type="hidden" name="mandi" id="hiddenMandi" value="<%= selectedMandi %>">
      <table class="table table-bordered table-hover" id="userTable">
        <thead class="table-dark">
          <tr>
            <th style="width: 5%;">Row</th>
            <th style="width: 15%;">District</th>
            <th style="width: 15%;">Mandi</th>
            <th style="width: 20%;">User Name</th>
            <th style="width: 25%;">Address</th>
            <th style="width: 15%;">Contact Number</th>
            <th style="width: 10%;">Action</th>
          </tr>
        </thead>
        <tbody id="userRowsWrapper">
          <% 
            // Group users by district and mandi
            const groupedData = {};
            users.forEach(u => {
              const district = u.district || 'Unknown';
              const mandi = u.mandi || 'Unknown';
              const districtKey = district;
              const mandiKey = `${district}_${mandi}`;
              if (!groupedData[districtKey]) {
                groupedData[districtKey] = { name: district, mandis: {} };
              }
              if (!groupedData[districtKey].mandis[mandi]) {
                groupedData[districtKey].mandis[mandi] = { name: mandi, users: [] };
              }
              groupedData[districtKey].mandis[mandi].users.push(u);
            });
            let globalRowCount = 1;
            Object.keys(groupedData).sort().forEach(districtKey => {
              const district = groupedData[districtKey];
              Object.keys(district.mandis).sort().forEach(mandiKey => {
                const mandi = district.mandis[mandiKey];
                mandi.users.forEach(u => {
          %>
            <tr class="userRow existingRow"
                data-category="<%= u.category %>"
                data-state="<%= u.state %>"
                data-district="<%= u.district %>"
                data-mandi="<%= u.mandi %>"
                data-name="<%= u.name %>"
                data-address="<%= u.address %>"
                data-contactnumber="<%= u.contactNumber %>"
                data-id="<%= u._id %>">
              <td class="rowNo"><%= globalRowCount++ %></td>
              <td><%= district.name %></td>
              <td><%= mandi.name %></td>
              <td><%= u.name %></td>
              <td><%= u.address %></td>
              <td><%= u.contactNumber %></td>
              <td>
                <button type="button"
                        class="btn btn-sm btn-primary editBtn me-1"
                        data-bs-toggle="modal"
                        data-bs-target="#editUserModal"
                        title="Edit">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <a href="/admin/userlist/delete/<%= u._id %>"
                   class="btn btn-sm btn-danger"
                   onclick="return confirm('Are you sure?')"
                   title="Delete">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
          <% 
                });
              });
            });
          %>
          <tr class="userRow addRow">
            <td class="rowNo"><%= globalRowCount %></td>
            <td><input type="text" class="form-control" value="<%= selectedDistrict || '' %>" name="districts[]"></td>
            <td><input type="text" class="form-control" value="<%= selectedMandi || '' %>" name="mandis[]"></td>
            <td><input type="text" name="names[]" class="form-control" placeholder="User Name" required></td>
            <td><input type="text" name="addresses[]" class="form-control" placeholder="Full Address" value="No"></td>
            <td><input type="text" name="contactNumbers[]" class="form-control" placeholder="Contact Number" required></td>
            <td><button type="button" class="btn btn-danger removeRow" style="display:none;"><i class="bi bi-x-circle"></i></button></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="7">
              <button type="submit" class="btn btn-success" id="saveAllBtn">Save All</button>
            </td>
          </tr>
        </tfoot>
      </table>

      <!-- PAGINATION -->
      <nav aria-label="User table pagination">
        <ul class="pagination justify-content-center" id="paginationControls">
          <!-- Pagination items will be generated by JS -->
        </ul>
      </nav>
    </form>
  </div>

  <!-- View Table Modal -->
  <div class="modal fade" id="viewTableModal" tabindex="-1" aria-labelledby="viewTableModalLabel" aria-hidden="true" style="padding-top: 50px;">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewTableModalLabel">User Data by District and Mandi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <div id="viewTableContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true" style="padding-top: 50px;">
    <div class="modal-dialog">
      <form id="editUserForm" method="POST">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editUserId" name="id">
            <div class="mb-2">
              <label>User Name</label>
              <input type="text" id="editName" name="name" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Address</label>
              <input type="text" id="editAddress" name="address" class="form-control">
            </div>
            <div class="mb-2">
              <label>Contact Number</label>
              <input type="text" id="editContactNumber" name="contactNumber" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Update</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap Icons CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Tabulator CSS -->
  <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css">
  <!-- jsPDF and AutoTable CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // State ID to Name mapping
      const stateMap = {};
      <% states.forEach(st => { %>
        stateMap['<%= st._id %>'] = '<%= st.name %>';
      <% }) %>

      // Initialize user data for Tabulator
      const userData = [
        <% 
          let rowCounter = 1;
          users.forEach(u => { %>
            {
              id: "<%= u._id %>",
              rowNo: <%= rowCounter++ %>,
              category: "<%= u.category %>",
              state: "<%= u.state %>",
              stateName: "<%= stateMap[u.state] || 'Unknown' %>",
              district: "<%= u.district || 'Unknown' %>",
              mandi: "<%= u.mandi || 'Unknown' %>",
              name: "<%= u.name %>",
              address: "<%= u.address %>",
              contactNumber: "<%= u.contactNumber %>"
            },
        <% }) %>
      ];

      // ------------------- FILTER DROPDOWNS -------------------
      const filterCategory = document.getElementById("filterCategory");
      const filterState = document.getElementById("filterState");
      const filterDistrict = document.getElementById("filterDistrict");
      const filterMandi = document.getElementById("filterMandi");
      const hiddenCategory = document.getElementById("hiddenCategory");
      const hiddenState = document.getElementById("hiddenState");
      const hiddenDistrict = document.getElementById("hiddenDistrict");
      const hiddenMandi = document.getElementById("hiddenMandi");

      function updateHiddenInputsAndFilter() {
        hiddenCategory.value = filterCategory.value;
        hiddenState.value = filterState.value;
        hiddenDistrict.value = filterDistrict.value;
        hiddenMandi.value = filterMandi.value;
        filterAndPaginate();
        updateAddRowState();
      }

      filterCategory.addEventListener("change", updateHiddenInputsAndFilter);
      filterState.addEventListener("change", function() {
        loadFilterDistricts(this.value, filterDistrict.value, filterDistrict, filterMandi);
        updateHiddenInputsAndFilter();
      });
      filterDistrict.addEventListener("change", function() {
        loadFilterMandis(this.value, filterMandi.value, filterMandi);
        updateHiddenInputsAndFilter();
      });
      filterMandi.addEventListener("change", updateHiddenInputsAndFilter);

      async function loadFilterDistricts(stateId, selectedDistrict = "", districtSelect, mandiSelect) {
        districtSelect.innerHTML = '<option value="">Select District</option>';
        mandiSelect.innerHTML = '<option value="">Select Mandi</option>';
        if (!stateId) return;
        try {
          const res = await fetch(`/admin/userlist/districts/${stateId}`);
          const districts = await res.json();
          districts.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            if (d === selectedDistrict) opt.selected = true;
            districtSelect.appendChild(opt);
          });
          if (selectedDistrict) loadFilterMandis(selectedDistrict, filterMandi.value, mandiSelect);
        } catch (err) {
          console.error('Error loading districts:', err);
        }
      }

      async function loadFilterMandis(district, selectedMandi = "", mandiSelect) {
        mandiSelect.innerHTML = '<option value="">Select Mandi</option>';
        if (!district) return;
        try {
          const res = await fetch(`/admin/userlist/mandis/${district}`);
          const mandis = await res.json();
          mandis.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m.name;
            opt.textContent = m.name;
            if (m.name === selectedMandi) opt.selected = true;
            mandiSelect.appendChild(opt);
          });
        } catch (err) {
          console.error('Error loading mandis:', err);
        }
      }

      // Initialize filter dropdowns with pre-selected values
      if (filterState.value) {
        loadFilterDistricts(filterState.value, filterDistrict.value, filterDistrict, filterMandi);
      }

      // ------------------- TABLE FILTERING AND PAGINATION -------------------
      const searchInput = document.getElementById('searchInput');
      let currentPage = 1;
      const rowsPerPage = 100;
      let filteredRows = [];

      function filterTableRows() {
        const searchVal = searchInput.value.toLowerCase();
        filteredRows = Array.from(document.querySelectorAll('.existingRow')).filter(row => {
          let match = true;
          if (searchVal) {
            match = row.textContent.toLowerCase().includes(searchVal);
          }
          if (match && filterCategory.value) match = row.dataset.category === filterCategory.value;
          if (match && filterState.value) match = row.dataset.state === filterState.value;
          if (match && filterDistrict.value) match = row.dataset.district === filterDistrict.value;
          if (match && filterMandi.value) match = row.dataset.mandi === filterMandi.value;
          return match;
        });
        return filteredRows;
      }

      function paginateRows() {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        currentPage = Math.min(currentPage, totalPages) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = filteredRows.slice(start, end);

        document.querySelectorAll('.existingRow').forEach(row => {
          row.style.display = 'none';
        });

        paginatedRows.forEach(row => {
          row.style.display = '';
        });

        // Update row numbers
        paginatedRows.forEach((row, index) => {
          row.querySelector('.rowNo').textContent = start + index + 1;
        });

        generatePagination(totalPages);
      }

      function generatePagination(totalPages) {
        const pagination = document.getElementById('paginationControls');
        pagination.innerHTML = '';

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement('li');
          li.className = `page-item ${i === currentPage ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
          pagination.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);

        pagination.querySelectorAll('a[data-page]').forEach(a => {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            const page = parseInt(a.dataset.page);
            if (page >= 1 && page <= totalPages) {
              currentPage = page;
              paginateRows();
            }
          });
        });
      }

      function filterAndPaginate() {
        const visibleRows = filterTableRows();
        const totalRows = document.querySelectorAll('.existingRow').length;
        document.getElementById('filteredRowCount').textContent = visibleRows.length;
        document.getElementById('totalRowCount').textContent = totalRows;
        paginateRows();
      }

      searchInput.addEventListener('input', filterAndPaginate);
      filterAndPaginate();

      // ------------------- ADD ROW LOGIC -------------------
      function updateAddRowState() {
        const addRows = document.querySelectorAll('.addRow');
        addRows.forEach(row => {
          const removeBtn = row.querySelector('.removeRow');
          removeBtn.style.display = addRows.length > 1 ? 'inline-block' : 'none';
          // Update District and Mandi inputs to reflect filter selections
          row.querySelector('td:nth-child(2) input').value = filterDistrict.value || '';
          row.querySelector('td:nth-child(3) input').value = filterMandi.value || '';
        });
        // Save button is always enabled
        document.getElementById('saveAllBtn').disabled = false;
      }

      const userRowsWrapper = document.getElementById("userRowsWrapper");
      userRowsWrapper.addEventListener("keydown", function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          const targetRow = e.target.closest('.addRow');
          if (targetRow) {
            e.preventDefault();
            addUserRow();
          }
        }
      });

      function addUserRow() {
        const index = document.querySelectorAll('.existingRow').length + document.querySelectorAll('.addRow').length + 1;
        const row = document.createElement("tr");
        row.className = "userRow addRow";
        row.innerHTML = `
          <td class="rowNo">${index}</td>
          <td><input type="text" class="form-control" value="${filterDistrict.value || ''}" name="districts[]"></td>
          <td><input type="text" class="form-control" value="${filterMandi.value || ''}" name="mandis[]"></td>
          <td><input type="text" name="names[]" class="form-control" placeholder="User Name" required></td>
          <td><input type="text" name="addresses[]" class="form-control" placeholder="Full Address" value="No"></td>
          <td><input type="text" name="contactNumbers[]" class="form-control" placeholder="Contact Number" required></td>
          <td><button type="button" class="btn btn-danger removeRow"><i class="bi bi-x-circle"></i></button></td>
        `;
        userRowsWrapper.appendChild(row);
        row.querySelector('input[name="names[]"]').focus();
        updateSerials();
        updateAddRowState();
      }

      userRowsWrapper.addEventListener("click", function(e) {
        if (e.target.closest(".removeRow")) {
          e.target.closest(".addRow").remove();
          updateSerials();
          updateAddRowState();
        }
      });

      function updateSerials() {
        const allRows = Array.from(document.querySelectorAll('.existingRow'));
        allRows.forEach((row, index) => {
          row.querySelector(".rowNo").textContent = index + 1;
        });
        const addRows = document.querySelectorAll('.addRow');
        addRows.forEach((row, index) => {
          row.querySelector('.rowNo').textContent = allRows.length + index + 1;
        });
        const totalRows = allRows.length;
        document.getElementById('totalRowCount').textContent = totalRows;
        filterAndPaginate();
      }

      document.addEventListener("keydown", function(e) {
        if (e.ctrlKey && e.key.toLowerCase() === 'c') {
          document.getElementById('addUserForm').submit();
        }
      });

      // ------------------- EDIT MODAL LOGIC -------------------
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", function() {
          const row = this.closest('.userRow');
          document.getElementById("editUserId").value = row.dataset.id;
          document.getElementById("editName").value = row.dataset.name;
          document.getElementById("editAddress").value = row.dataset.address;
          document.getElementById("editContactNumber").value = row.dataset.contactnumber;
          document.getElementById("editUserForm").action = `/admin/userlist/edit/${row.dataset.id}`;
        });
      });

      // ------------------- VIEW TABLE MODAL LOGIC -------------------
      let viewTable = null;
      const viewTableModal = document.getElementById('viewTableModal');
      viewTableModal.addEventListener('shown.bs.modal', function() {
        if (viewTable) {
          viewTable.destroy();
        }

        // Filter user data based on current filters
        const filteredData = userData.filter(row => {
          let match = true;
          if (searchInput.value) {
            match = (
              row.name.toLowerCase().includes(searchInput.value.toLowerCase()) ||
              row.address.toLowerCase().includes(searchInput.value.toLowerCase()) ||
              row.contactNumber.toLowerCase().includes(searchInput.value.toLowerCase())
            );
          }
          if (match && filterCategory.value) match = row.category === filterCategory.value;
          if (match && filterState.value) match = row.state === filterState.value;
          if (match && filterDistrict.value) match = row.district === filterDistrict.value;
          if (match && filterMandi.value) match = row.mandi === filterMandi.value;
          return match;
        });

        // Assign new row numbers for display
        filteredData.forEach((row, index) => {
          row.rowNo = index + 1;
        });

        viewTable = new Tabulator("#viewTableContent", {
          data: filteredData,
          layout: "fitColumns",
          groupBy: "stateName",
          groupToggleElement: "header",
          groupHeader: function(value) {
            return `${value}`;
          },
          columns: [
            { title: "Row", field: "rowNo", width: 80, sorter: "number" },
            { title: "District", field: "district", sorter: "string" },
            { title: "Mandi", field: "mandi", sorter: "string" },
            { title: "User Name", field: "name", sorter: "string" },
            { title: "Address", field: "address", sorter: "string" },
            { title: "Contact Number", field: "contactNumber", sorter: "string" }
          ],
          initialSort: [
            { column: "stateName", dir: "asc" },
            { column: "district", dir: "asc" },
            { column: "mandi", dir: "asc" },
            { column: "rowNo", dir: "asc" }
          ]
        });
      });

      viewTableModal.addEventListener('hidden.bs.modal', function() {
        if (viewTable) {
          viewTable.destroy();
          viewTable = null;
        }
      });

      // ------------------- EXPORT FUNCTIONS -------------------
      function getExportData() {
        const filteredData = userData.filter(row => {
          let match = true;
          if (searchInput.value) {
            match = (
              row.name.toLowerCase().includes(searchInput.value.toLowerCase()) ||
              row.address.toLowerCase().includes(searchInput.value.toLowerCase()) ||
              row.contactNumber.toLowerCase().includes(searchInput.value.toLowerCase())
            );
          }
          if (match && filterCategory.value) match = row.category === filterCategory.value;
          if (match && filterState.value) match = row.state === filterState.value;
          if (match && filterDistrict.value) match = row.district === filterDistrict.value;
          if (match && filterMandi.value) match = row.mandi === filterMandi.value;
          return match;
        });

        filteredData.forEach((row, index) => {
          row.rowNo = index + 1;
        });

        return filteredData;
      }

      document.getElementById('downloadCSV').addEventListener('click', function() {
        const data = getExportData();
        let csv = 'Row,District,Mandi,User Name,Address,Contact Number\n';
        data.forEach(row => {
          const rowData = [
            row.rowNo,
            `"${row.district.replace(/"/g, '""')}"`,
            `"${row.mandi.replace(/"/g, '""')}"`,
            `"${row.name.replace(/"/g, '""')}"`,
            `"${row.address.replace(/"/g, '""')}"`,
            `"${row.contactNumber.replace(/"/g, '""')}"`
          ].join(',');
          csv += `${rowData}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'users.csv';
        a.click();
        window.URL.revokeObjectURL(url);
      });

      document.getElementById('downloadExcel').addEventListener('click', function() {
        const data = getExportData();
        const wsData = [['Row', 'District', 'Mandi', 'User Name', 'Address', 'Contact Number']];
        data.forEach(row => {
          wsData.push([
            row.rowNo,
            row.district,
            row.mandi,
            row.name,
            row.address,
            row.contactNumber
          ]);
        });
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Users');
        XLSX.writeFile(wb, 'users.xlsx');
      });

      document.getElementById('downloadPDF').addEventListener('click', function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = getExportData();
        const tableData = [['Row', 'District', 'Mandi', 'User Name', 'Address', 'Contact Number']];
        data.forEach(row => {
          tableData.push([
            row.rowNo,
            row.district,
            row.mandi,
            row.name,
            row.address,
            row.contactNumber
          ]);
        });
        doc.autoTable({
          head: [tableData[0]],
          body: tableData.slice(1),
          theme: 'striped',
          styles: { fontSize: 8, cellPadding: 2 },
          columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 20 },
            2: { cellWidth: 20 },
            3: { cellWidth: 30 },
            4: { cellWidth: 40 },
            5: { cellWidth: 20 }
          },
          margin: { top: 10 }
        });
        doc.save('users.pdf');
      });
    });
  </script>
</div>

<%- include('common/footer') %>