<%- include('common/header') %>

<div class="main-content" id="mainContent">
  <div class="container mt-4">
    <h2 class="mb-4">Mandi List</h2>

    <!-- Filters and Buttons -->
    <div class="row mb-3 align-items-end">
      <div class="col-md-2">
        <input type="text" id="searchSerial" class="form-control" placeholder="S.No">
      </div>
      <div class="col-md-2">
        <input type="text" id="searchName" class="form-control" placeholder="Mandi Name">
      </div>
      <div class="col-md-2">
        <select id="filterState" class="form-select">
          <option value="">All States</option>
          <% states.forEach(state => { %>
            <option value="<%= state._id %>"><%= state.name %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-2">
        <select id="filterDistrict" class="form-select">
          <option value="">All Districts</option>
        </select>
      </div>
      <div class="col-md-4">
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addMandiModal">
          <i class="bi bi-plus-circle"></i> Add Mandis
        </button>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#viewTableModal">
          <i class="bi bi-table"></i> View Table
        </button>
        <div class="btn-group">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-download"></i> Download
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="download-csv">Download CSV</a></li>
            <li><a class="dropdown-item" href="#" id="download-xlsx">Download Excel</a></li>
            <li><a class="dropdown-item" href="#" id="download-pdf">Download PDF</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Bulk Delete Form -->
    <form id="bulkDeleteForm" action="/admin/mandis/delete-many" method="POST">
      <div id="mandiTable"></div>
      <button type="submit" class="btn btn-danger mt-2">
        <i class="bi bi-trash"></i> Delete Selected
      </button>
    </form>

    <!-- Add Mandis Modal (Multiple) -->
    <div class="modal fade" id="addMandiModal" tabindex="-1" aria-labelledby="addMandiModalLabel" aria-hidden="true" style="padding-top: 100px;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="addMandiForm" method="POST" action="/admin/mandis/add">
            <div class="modal-header">
              <h5 class="modal-title">Add Multiple Mandis</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label>State</label>
                <select name="state" id="addState" class="form-select" required>
                  <option value="">Select State</option>
                  <% states.forEach(state => { %>
                    <option value="<%= state._id %>"><%= state.name %></option>
                  <% }) %>
                </select>
              </div>
              <div class="mb-3">
                <label>District</label>
                <select name="district" id="addDistrict" class="form-select" required>
                  <option value="">Select District</option>
                </select>
              </div>
              <div id="mandiNamesWrapper">
                <div class="mb-3 mandiNameRow">
                  <label>Mandi Name</label>
                  <div class="input-group">
                    <input type="text" name="names[]" class="form-control" required>
                    <button type="button" class="btn btn-danger removeRow"><i class="bi bi-x-circle"></i> Remove</button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-secondary" id="addMoreBtn">
                <i class="bi bi-plus"></i> Add More Mandi
              </button>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Save Mandis</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Mandi Modal -->
    <div class="modal fade" id="editMandiModal" tabindex="-1" aria-hidden="true"  style="padding-top: 50px;">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editMandiForm" method="POST">
            <div class="modal-header">
              <h5 class="modal-title">Edit Mandi</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="editMandiId" name="id">
              <div class="mb-3">
                <label>State</label>
                <select name="state" id="editState" class="form-select" required>
                  <option value="">Select State</option>
                  <% states.forEach(state => { %>
                    <option value="<%= state._id %>"><%= state.name %></option>
                  <% }) %>
                </select>
              </div>
              <div class="mb-3">
                <label>District</label>
                <select name="district" id="editDistrict" class="form-select" required>
                  <option value="">Select District</option>
                </select>
              </div>
              <div class="mb-3">
                <label>Mandi Name</label>
                <input type="text" name="name" id="editName" class="form-control" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Update</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Table Modal -->
    <div class="modal fade" id="viewTableModal" tabindex="-1" aria-hidden="true" style="padding-top: 50px;">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewTableModalLabel">View Mandi Table (State & District-Wise)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="viewMandiTable"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css">
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Initialize Mandi Data
        const mandiData = [
          <% mandis.forEach((mandi, index) => { %>
            {
              id: "<%= mandi._id %>",
              overallSno: <%= index + 1 %>,
              stateDistrictSno: 0,
              name: "<%= mandi.name %>",
              district: "<%= mandi.district %>",
              stateId: "<%= mandi.state._id %>",
              state: "<%= mandi.state.name %>"
            },
          <% }) %>
        ];

        // Add stateDistrictSno for grouping
        const groupedData = {};
        mandiData.forEach(mandi => {
          const key = `${mandi.state}_${mandi.district}`;
          if (!groupedData[key]) {
            groupedData[key] = [];
          }
          groupedData[key].push(mandi);
        });

        let sno = 1;
        Object.values(groupedData).forEach(group => {
          group.forEach(mandi => {
            mandi.stateDistrictSno = sno++;
          });
        });

        // Initialize Main Table
        const mainTable = new Tabulator("#mandiTable", {
          data: mandiData,
          layout: "fitColumns",
          selectable: true,
          columns: [
            { formatter: "rowSelection", titleFormatter: "rowSelection", hozAlign: "center", headerSort: false, width: 50 },
            { title: "Overall S.No", field: "overallSno", width: 100, sorter: "number" },
            { title: "Name", field: "name", sorter: "string" },
            { title: "District", field: "district", sorter: "string" },
            { title: "State", field: "state", sorter: "string" },
            {
              title: "Actions",
              field: "actions",
              hozAlign: "center",
              formatter: function(cell) {
                const id = cell.getRow().getData().id;
                const name = cell.getRow().getData().name;
                const state = cell.getRow().getData().stateId;
                const district = cell.getRow().getData().district;
                return `
                  <button type="button" class="btn btn-sm btn-primary editBtn"
                    data-id="${id}" data-name="${name}" data-state="${state}" data-district="${district}"
                    title="Edit" data-bs-toggle="modal" data-bs-target="#editMandiModal">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <form action="/admin/mandis/delete/${id}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                `;
              },
              headerSort: false
            }
          ],
          initialSort: [
            { column: "state", dir: "asc" },
            { column: "district", dir: "asc" },
            { column: "name", dir: "asc" }
          ]
        });

        // Update hidden inputs for bulk delete
        mainTable.on("rowSelectionChanged", function(data) {
          const form = document.getElementById("bulkDeleteForm");
          form.querySelectorAll("input[name='ids[]']").forEach(el => el.remove());
          data.forEach(row => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "ids[]";
            input.value = row.id;
            form.appendChild(input);
          });
        });

        // Initialize View Table in Modal
        let viewTable = null;
        const viewTableModal = document.getElementById("viewTableModal");
        viewTableModal.addEventListener("shown.bs.modal", function() {
          if (viewTable) {
            viewTable.destroy(); // Destroy previous instance to avoid duplicates
          }

          viewTable = new Tabulator("#viewMandiTable", {
            data: mandiData,
            layout: "fitColumns",
            groupBy: "state",
            groupToggleElement: "header",
            groupHeader: function(value, count, data, group) {
              return `${value}`; // Display only the state name
            },
            columns: [
              { title: "S.No", field: "stateDistrictSno", width: 80, sorter: "number" },
              { title: "Mandi Name", field: "name", sorter: "string" },
              { title: "District", field: "district", sorter: "string" },
              { title: "State", field: "state", sorter: "string" }
            ],
            initialSort: [
              { column: "state", dir: "asc" },
              { column: "district", dir: "asc" },
              { column: "stateDistrictSno", dir: "asc" }
            ]
          });
        });

        // Clean up table when modal is hidden
        viewTableModal.addEventListener("hidden.bs.modal", function() {
          if (viewTable) {
            viewTable.destroy();
            viewTable = null;
          }
        });

        // Filters & Search
        const searchSerial = document.getElementById("searchSerial");
        const searchName = document.getElementById("searchName");
        const filterState = document.getElementById("filterState");
        const filterDistrict = document.getElementById("filterDistrict");

        filterState.addEventListener("change", async function() {
          const stateId = this.value;
          filterDistrict.innerHTML = '<option value="">All Districts</option>';
          if (!stateId) return;
          const res = await fetch(`/admin/mandis/districts/${stateId}`);
          const districts = await res.json();
          districts.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            filterDistrict.appendChild(opt);
          });
          filterTable();
        });

        [searchSerial, searchName, filterState, filterDistrict].forEach(el => {
          el.addEventListener("input", filterTable);
          el.addEventListener("change", filterTable);
        });

        function filterTable() {
          const snoFilter = searchSerial.value.toLowerCase();
          const nameFilter = searchName.value.toLowerCase();
          const stateFilter = filterState.value;
          const districtFilter = filterDistrict.value;

          mainTable.setFilter([
            { field: "overallSno", type: "like", value: snoFilter },
            { field: "name", type: "like", value: nameFilter },
            { field: "stateId", type: stateFilter ? "=" : "like", value: stateFilter },
            { field: "district", type: districtFilter ? "=" : "like", value: districtFilter }
          ]);
        }

        // Download Buttons
        document.getElementById("download-csv").addEventListener("click", function() {
          mainTable.download("csv", "mandi_list.csv", { columns: ["overallSno", "name", "district", "state"] });
        });

        document.getElementById("download-xlsx").addEventListener("click", function() {
          mainTable.download("xlsx", "mandi_list.xlsx", { sheetName: "Mandi List", columns: ["overallSno", "name", "district", "state"] });
        });

        document.getElementById("download-pdf").addEventListener("click", function() {
          mainTable.download("pdf", "mandi_list.pdf", {
            orientation: "portrait",
            title: "Mandi List",
            autoTable: {
              theme: "grid",
              styles: { fontSize: 10 },
              headStyles: { fillColor: [41, 128, 185] },
              margin: { top: 30 },
              columns: [
                { header: "Overall S.No", dataKey: "overallSno" },
                { header: "Name", dataKey: "name" },
                { header: "District", dataKey: "district" },
                { header: "State", dataKey: "state" }
              ]
            }
          });
        });

        // Edit Button Modal
        document.addEventListener("click", async function(e) {
          if (e.target.closest(".editBtn")) {
            const btn = e.target.closest(".editBtn");
            const id = btn.dataset.id;
            const name = btn.dataset.name;
            const state = btn.dataset.state;
            const district = btn.dataset.district;

            document.getElementById("editMandiId").value = id;
            document.getElementById("editName").value = name;
            document.getElementById("editState").value = state;

            const res = await fetch(`/admin/mandis/districts/${state}`);
            const districts = await res.json();
            const districtSelect = document.getElementById("editDistrict");
            districtSelect.innerHTML = '<option value="">Select District</option>';
            districts.forEach(d => {
              const opt = document.createElement("option");
              opt.value = d;
              opt.textContent = d;
              if (d === district) opt.selected = true;
              districtSelect.appendChild(opt);
            });

            document.getElementById("editMandiForm").action = `/admin/mandis/update/${id}`;
          }
        });

        // Add Multiple Mandis Modal
        const addState = document.getElementById("addState");
        const addDistrict = document.getElementById("addDistrict");
        const addMoreBtn = document.getElementById("addMoreBtn");
        const mandiNamesWrapper = document.getElementById("mandiNamesWrapper");

        addState.addEventListener("change", async function() {
          const stateId = this.value;
          addDistrict.innerHTML = '<option value="">Select District</option>';
          if (!stateId) return;
          const res = await fetch(`/admin/mandis/districts/${stateId}`);
          const districts = await res.json();
          districts.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            addDistrict.appendChild(opt);
          });
        });

        addMoreBtn.addEventListener("click", () => {
          const row = document.createElement("div");
          row.classList.add("mb-3", "mandiNameRow");
          row.innerHTML = `
            <label>Mandi Name</label>
            <div class="input-group">
              <input type="text" name="names[]" class="form-control" required>
              <button type="button" class="btn btn-danger removeRow"><i class="bi bi-x-circle"></i> Remove</button>
            </div>
          `;
          mandiNamesWrapper.appendChild(row);
          row.querySelector(".removeRow").addEventListener("click", () => row.remove());
        });

        document.querySelectorAll(".removeRow").forEach(btn => {
          btn.addEventListener("click", e => e.target.closest(".mandiNameRow").remove());
        });
      });
    </script>
  </div>

<%- include('common/footer') %>